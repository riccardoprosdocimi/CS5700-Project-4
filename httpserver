#!/usr/bin/env python3
import argparse
from http.server import BaseHTTPRequestHandler, HTTPServer
from functools import lru_cache
from urllib.request import urlopen

PORT = 25016
ORIGIN_PORT = "8080"
ORIGIN_SERVER = "cs5700cdnorigin.ccs.neu.edu"


class CdnHttpHandler(BaseHTTPRequestHandler):

    def do_GET(self):
        data = self.get_data(self.path)
        self.send_response(200)
        self.send_header("Content-Type", "text/html; charset=utf-8")
        self.send_header("Content-Length", str(len(data)))
        self.send_header("Host", "localhost")
        self.end_headers()
        self.wfile.write(data)

    @staticmethod
    @lru_cache
    def get_data(path: str) -> bytes:
        print("Not cached")
        with urlopen("http://" + ORIGIN_SERVER + ":" + ORIGIN_PORT + path) as response:
            return response.read()


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("-p", type=int, help="the port number the server will bind to")
    parser.add_argument("-o", type=str, help="the name of the origin server")
    args = parser.parse_args()
    return args


def main():
    global ORIGIN_SERVER
    args = parse_args()
    port = args.p
    ORIGIN_SERVER = args.o
    web_server = HTTPServer(("localhost", port), CdnHttpHandler)
    try:
        web_server.serve_forever()
    except KeyboardInterrupt:
        pass
    web_server.server_close()
    print("server stopped")


if __name__ == "__main__":
    main()
