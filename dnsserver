#!/usr/bin/env python3
import argparse
from dnslib.server import DNSServer, DNSLogger, DNSError
from dnslib.dns import RR
from utils import get_local_ip
from random import randrange

DNS_SERVER = "localhost"  # "proj4-dns.5700.network"
DNS_SERVER_IP = "97.107.140.73"

CDN_NAME = "cs5700cdn.example.com"
TTL = 60


class Resolver:
    CLIENT_IPS: set = set()
    REPLICAS = [
        ("proj4-repl1.5700.network", "139.144.30.25"),
        ("proj4-repl2.5700.network", "173.255.210.124"),
        ("proj4-repl3.5700.network", "139.144.69.56"),
        ("proj4-repl4.5700.network", "185.3.95.25"),
        ("proj4-repl5.5700.network", "139.162.83.107"),
        ("proj4-repl6.5700.network", "192.46.211.228"),
        ("proj4-repl7.5700.network", "170.187.240.5")
    ]

    @staticmethod
    def resolve(request, handler):
        if request.q.qname == CDN_NAME:
            Resolver.CLIENT_IPS.add(handler.client_address)
            response = request.reply()
            random_replica = randrange(len(Resolver.REPLICAS))
            replica_domain_name, replica_ip = Resolver.REPLICAS[random_replica]
            response.add_answer(
                *RR.fromZone(f"{replica_domain_name}. {TTL} A {replica_ip}"))
            return response

        raise DNSError(f"Not authoritative for {request.q.qname}")


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "-p", type=int, help="the port number the server will bind to")
    parser.add_argument(
        "-n", type=str, help="the CDN-specific name that the server translates to an IP.")
    args = parser.parse_args()
    return args


def main():
    global CDN_NAME
    args = parse_args()
    port = args.p
    CDN_NAME = args.n
    resolver = Resolver()
    logger = DNSLogger(prefix=False)
    server = DNSServer(resolver, logger=logger,
                       port=port, address=get_local_ip())
    try:
        server.start()
    except KeyboardInterrupt:
        pass
    server.stop()
    print("Server stopped")


if __name__ == "__main__":
    main()
